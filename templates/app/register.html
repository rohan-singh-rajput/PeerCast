{% extends 'base.html' %}
{% block content %}

<body class="bg-gray-50 font-sans text-gray-800">

    <!-- Header -->
    <header class="bg-white bg-opacity-60 backdrop-blur-lg fixed top-0 w-full p-4 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <a href="{% url 'home' %}" class="text-3xl font-semibold text-gray-900 tracking-wide">PeerCast</a>
        </div>
    </header>

    <!-- Signup Section -->
    <section class="flex items-center justify-center h-screen">
        <div class="bg-white rounded-xl shadow-lg p-8 max-w-md w-full">
            <h2 class="text-3xl font-semibold text-gray-900 mb-6 text-center">Create an Account</h2>

            <form id="signupForm" method="post">
                {% csrf_token %}

                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2" for="username">Username</label>
                    <input type="text" name="username" id="username" class="w-full px-4 py-2 border rounded-lg"
                        placeholder="Enter your Username" required>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2" for="email">Email</label>
                    <input type="email" name="email" id="email" class="w-full px-4 py-2 border rounded-lg"
                        placeholder="Enter your Email" required>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2" for="password">Password</label>
                    <input type="password" name="password" id="password" class="w-full px-4 py-2 border rounded-lg"
                        placeholder="Create a password" required>
                </div>

                <button id="signupBtn" type="button"
                    class="bg-gray-900 text-white px-6 py-2 rounded-full shadow-md hover:bg-gray-700 transition-all w-full">
                    Sign Up & Register Device
                </button>
            </form>

            <p class="text-center text-gray-600 mt-4">
                Already have an account?
                <a href="{% url 'login' %}" class="text-blue-600 hover:underline">Login</a>
            </p>

            <div id="webauthnStatus" class="text-sm mt-4"></div>
        </div>
    </section>

    <script>
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        function base64UrlToBuffer(str) {
            str = str.replace(/-/g, '+').replace(/_/g, '/');
            const pad = str.length % 4;
            if (pad) str += '='.repeat(4 - pad);
            const decoded = atob(str);
            const array = new Uint8Array(decoded.length);
            for (let i = 0; i < decoded.length; i++) {
                array[i] = decoded.charCodeAt(i);
            }
            return array.buffer;
        }

        function bufferToBase64Url(buffer) {
            const bytes = new Uint8Array(buffer);
            let str = "";
            for (let i = 0; i < bytes.length; i++) str += String.fromCharCode(bytes[i]);
            let b64 = btoa(str);
            return b64.replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
        }

        function showStatus(msg, error = false) {
            const el = document.getElementById("webauthnStatus");
            el.textContent = msg;
            el.style.color = error ? "crimson" : "green";
        }

        document.getElementById("signupBtn").addEventListener("click", async () => {
            const username = document.getElementById("username").value.trim();
            const email = document.getElementById("email").value.trim();
            const password = document.getElementById("password").value;

            if (!username || !email || !password) {
                showStatus("Please fill username, email, and password.", true);
                return;
            }

            showStatus("Creating account...");

            try {
                const csrftoken = getCookie("csrftoken");

                // create Django user account
                const regResp = await fetch("{% url 'register' %}", {
                    method: "POST",
                    credentials: "same-origin",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrftoken
                    },
                    body: JSON.stringify({ username, email, password })
                });

                const regJson = await regResp.json();
                if (!regResp.ok) throw new Error(regJson.error || "Signup failed");

                // IMPORTANT: WebAuthn user_id MUST ALWAYS BE EMAIL
                const user_id = email;

                showStatus("Account created — registering passkey...");

                // 1️⃣ request WebAuthn create options
                const optResp = await fetch("/webauthn/register/options", {
                    method: "POST",
                    credentials: "same-origin",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrftoken
                    },
                    body: JSON.stringify({
                        user_id: email,
                        username: email,          // everything aligned to email
                        displayName: email,
                        email
                    })
                });

                const options = await optResp.json();
                if (!optResp.ok) throw new Error(options.error || "options failed");

                // convert fields
                options.challenge = base64UrlToBuffer(options.challenge);
                options.user.id = base64UrlToBuffer(options.user.id);

                if (options.excludeCredentials) {
                    options.excludeCredentials = options.excludeCredentials.map(c => ({
                        ...c,
                        id: base64UrlToBuffer(c.id)
                    }));
                }

                // 2️⃣ create credential
                const credential = await navigator.credentials.create({ publicKey: options });

                const attestationObject = bufferToBase64Url(credential.response.attestationObject);
                const clientDataJSON = bufferToBase64Url(credential.response.clientDataJSON);
                const rawId = bufferToBase64Url(credential.rawId);

                // 3️⃣ send result for server verification
                const verifyResp = await fetch("/webauthn/register/verify", {
                    method: "POST",
                    credentials: "same-origin",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrftoken
                    },
                    body: JSON.stringify({
                        user_id: email,
                        id: credential.id,
                        rawId,
                        type: credential.type,
                        response: {
                            clientDataJSON,
                            attestationObject
                        }
                    })
                });

                const verifyJson = await verifyResp.json();
                if (!verifyResp.ok) throw new Error(verifyJson.error);

                showStatus("Passkey registered successfully! You can now login.");

            } catch (err) {
                console.error(err);
                showStatus("Error: " + err.message, true);
            }
        });
    </script>

</body>
{% endblock %}